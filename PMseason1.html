<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manufacturing Adventure — Season 1 (Statement of Cost Focus)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 20px; }
    .card {
      background:#121b32; border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:16px; box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    h1,h2,h3 { margin: 0 0 10px; }
    h1 { font-size: 22px; }
    h2 { font-size: 18px; opacity: .95; }
    p { margin: 8px 0; line-height: 1.45; opacity: .95; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 920px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button, a.btn {
      display:inline-block;
      background:#1c2b55; color:#e9eefc; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;
      transition: transform .05s ease, background .15s ease;
      text-decoration:none;
    }
    button:hover, a.btn:hover { background:#22356b; }
    button:active, a.btn:active { transform: translateY(1px); }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .primary { background:#2b4aa8; border-color: rgba(255,255,255,.16); }
    .primary:hover { background:#3557c2; }
    .muted { opacity:.75; }
    .small { font-size: 13px; opacity:.85; }
    .pillrow { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 0; align-items:center; }
    .pill {
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10);
      padding:6px 10px; border-radius:999px; font-size: 13px;
    }
    .mono { font-variant-numeric: tabular-nums; }
    .hr { height:1px; background:rgba(255,255,255,.10); margin: 12px 0; }

    .reveal { background:#0f1730; border:1px dashed rgba(255,255,255,.16); border-radius:14px; padding:12px; margin-top:12px; }
    .hidden { display:none; }
    .danger { color:#ffb1b1; }
    .ok { color:#b7ffcf; }

    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.10); padding: 8px 6px; }
    th { text-align:left; opacity:.85; font-size: 13px; }
    td:last-child, th:last-child { text-align:right; }
    tr.clickable { cursor:pointer; }
    tr.clickable:hover { background: rgba(255,255,255,.04); }
    .caret { opacity:.9; margin-right: 6px; display:inline-block; width: 14px; }
    .workrow td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .workbox {
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px; padding:10px; line-height:1.4;
    }
    details { margin-top: 8px; }
    summary { cursor:pointer; opacity:.9; }
    summary:hover { opacity: 1; }

    .footer { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; align-items:center; }
    .linkbtn { background:#1c2b55; }

    .rightTitle { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .statusLine { margin-top: 8px; }
    .socHeaderLine { display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top: 4px; }

    .headerRow { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start; }
    .headerActions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }

    /* Smaller, subtler header buttons (sizing A) */
    .miniBtn { padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .miniBtn.ghost { background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.10); }
    .miniBtn.ghost:hover { background: rgba(255,255,255,.11); }

    /* Episode header cleaner (button goes below title) */
    .epHeader { display:block; }
    .epHeaderTop { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .epHeaderTop h2 { margin:0; }
    .epHeaderBelow { margin-top: 8px; display:flex; gap:8px; flex-wrap:wrap; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(18,27,50,.95); border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; box-shadow: 0 12px 30px rgba(0,0,0,.35);
      font-size: 13px; opacity: 0; pointer-events:none; transition: opacity .2s ease;
      max-width: 92vw;
    }
    .toast.show { opacity: 1; }
    .scoreBox {
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px; padding:12px;
    }
    .scoreGrid { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 560px) { .scoreGrid { grid-template-columns: 1fr 1fr; } }
    .kbd {
      display:inline-block; padding:2px 7px; border-radius:8px;
      border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06);
      font-size: 12px; opacity:.95;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HEADER -->
    <div class="card">
      <div class="headerRow">
        <div style="min-width: 260px;">
          <h1 style="margin-bottom:6px;">Manufacturing Adventure — Season 1 (Statement of Cost Focus)</h1>
          <p class="muted" style="margin-top:0;">
            Choose A / B / C. You only see the cost impact after selecting.
            Objective: <b>minimize total Cost of Production (Total COP)</b> while meeting every <b>output target</b>.
            Cutting cost “too much” can trigger <b>scrap</b> or <b>complaints</b> → <b>burst</b>.
          </p>
        </div>

        <!-- Top header actions (Layout A): Season-level only -->
        <div class="headerActions">
          <a class="btn miniBtn ghost" href="https://accountingaventure.wordpress.com/manufacturing-adventure-season-1/" target="_blank" rel="noopener">Season Guide</a>
          <a class="btn miniBtn ghost" href="https://accountingaventure.wordpress.com/glossary-list-in-the-episodes-season-1/" target="_blank" rel="noopener">Glossary</a>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <!-- LEFT -->
      <div class="card" id="mainCard">

        <!-- PRE-EPISODE SCREEN -->
        <div id="preEpisode">
          <h2>Instruction Manual & Strategy Guide (Statement of Cost Focus)</h2>
          <p class="muted">
            <b>Backstory:</b> You’re the Production &amp; Cost Control Lead of a newly launched manufacturing business.
            Each episode is a production period. Management wants you to hit the output target while keeping manufacturing costs under control.
            Cutting costs too aggressively can backfire: scrap rises, complaints increase, and you can burst (game over).
          </p>

          <div class="scoreBox">
            <h3 style="margin:0 0 6px;">How you win</h3>
            <div class="small muted">
              • Your score is <b>Total COP</b> across Episodes 2–8 (lower is better).<br/>
              • You must meet every episode’s <b>output target</b> (good units).<br/>
              • You burst immediately if <b>Scrap ≥ 3%</b> or <b>Quality risk ≥ 3</b>.<br/>
              • You also burst if <b>Needed production units &gt; Capacity</b> (target becomes impossible).<br/>
              • After each choice, the right panel shows a <b>Statement of Cost (SOC)</b> and you can click lines to see workings.
            </div>
          </div>

          <div class="footer">
            <button class="primary" id="startSeasonBtn">Start Season</button>
            <span class="small muted">If you’re new, open <span class="kbd">Season Guide</span> / <span class="kbd">Glossary</span> above.</span>
          </div>
        </div>

        <!-- EPISODE SCREEN -->
        <div id="episodeScreen" class="hidden">
          <div class="epHeader">
            <div class="epHeaderTop">
              <h2 id="epTitle">Episode</h2>
            </div>
            <!-- Episode button moved below title (Header A) -->
            <div class="epHeaderBelow">
              <a class="btn miniBtn ghost" id="epGuideBtn" href="#" target="_blank" rel="noopener">Read Episode Guide</a>
            </div>
          </div>

          <p id="story"></p>

          <!-- Left pills: Episode + Reason only -->
          <div class="pillrow mono" id="epMetaPills"></div>

          <div class="btns" id="choiceButtons"></div>

          <div class="reveal hidden" id="revealBox">
            <h3 style="margin-bottom:6px;">Post-choice reveal</h3>
            <div id="revealText"></div>

            <div class="hr"></div>

            <div class="footer">
              <button class="primary" id="nextBtn">Next Episode</button>
              <button class="linkbtn" id="restartBtn">Restart Season</button>
            </div>
          </div>

          <div class="reveal hidden" id="gameOverBox">
            <h3 class="danger">Game Over — Burst</h3>
            <div id="gameOverText"></div>
            <div class="footer">
              <button class="primary" id="retryBtn">Retry from Start</button>
            </div>
            <p class="small muted">“Video deep dive” only appears after Season Complete (not on Game Over).</p>
          </div>

          <div class="reveal hidden" id="seasonCompleteBox">
            <h3 class="ok">Season Complete ✅</h3>
            <div id="seasonSummary"></div>

            <div class="hr"></div>

            <div class="scoreBox">
              <h3 style="margin:0 0 6px;">Your score vs best score</h3>
              <div class="scoreGrid mono">
                <div>
                  <div class="small muted">Your Total COP</div>
                  <div style="font-size:18px; font-weight:800;" id="yourCop"></div>
                </div>
                <div>
                  <div class="small muted">Best Total COP</div>
                  <div style="font-size:18px; font-weight:800;" id="bestCop"></div>
                </div>
                <div>
                  <div class="small muted">Deviation</div>
                  <div style="font-size:18px; font-weight:800;" id="deviation"></div>
                </div>
                <div>
                  <div class="small muted">End status</div>
                  <div class="small" id="endStatus"></div>
                </div>
              </div>
            </div>

            <div class="footer">
              <button class="primary" id="playAgainBtn">Play Again</button>
              <button class="linkbtn" id="shareBtn">Share Result</button>
              <button class="linkbtn" id="videoBtn">Video deep dive (placeholder)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="rightPanel">
        <div class="rightTitle">
          <h2 style="margin:0;">Dashboard</h2>
          <div class="small muted mono">Season: 1</div>
        </div>

        <div class="pillrow mono">
          <div class="pill">Total COP: <span id="totalCop"></span></div>
          <div class="pill">Quality risk: <span id="qRisk"></span></div>
          <div class="pill">Scrap: <span id="scrap"></span></div>
        </div>

        <div class="statusLine small muted" id="statusLine"></div>

        <div class="hr"></div>

        <div class="socHeaderLine">
          <h3 style="margin:0;">Statement of Cost</h3>
          <div class="small muted mono" id="socLabel"></div>
        </div>
        <div class="small muted">Click a row to reveal the workings (simple explanation). Advanced details are optional.</div>
        <table class="mono" id="socTable"></table>

        <div class="hr"></div>

        <h3 style="margin:0 0 6px;">Cost model (current)</h3>
        <div class="small muted mono" id="costModelBox"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Constants ----------
  const BEST_COP = 183538;

  const GAME_BASE_URL = "https://accounting-adventure.pages.dev/PMseason1";
  const UTM = "utm_source=game_share&utm_medium=share_button&utm_campaign=PMseason1";
  const SHARE_URL = `${GAME_BASE_URL}?${UTM}`;

  const EP_GUIDES = {
    1: "https://accountingaventure.wordpress.com/episode-1-set-up-your-factory-fixed-costs-vs-capacity/",
    2: "https://accountingaventure.wordpress.com/episode-2-materials-sourcing-unit-cost-vs-hidden-waste/",
    3: "https://accountingaventure.wordpress.com/episode-3-ramp-up-decision-incremental-cost-vs-future-rework/",
    4: "https://accountingaventure.wordpress.com/episode-4-quality-control-vs-cost-cutting-visible-cost-vs-hidden-cost/",
    5: "https://accountingaventure.wordpress.com/episode-5-maintenance-the-sunk-cost-trap-relevant-vs-irrelevant/",
    6: "https://accountingaventure.wordpress.com/episode-6-locked-orders-capacity-scrap-can-break-you/",
    7: "https://accountingaventure.wordpress.com/episode-7-complaints-response-spend-smart-not-big/",
    8: "https://accountingaventure.wordpress.com/episode-8-finale-finish-strong-without-risk-spikes/"
  };

  // ---------- Utilities ----------
  const fmt = (n) => (Math.round(n * 100) / 100).toLocaleString(undefined, {maximumFractionDigits: 2});
  const ceil = (n) => Math.ceil(n);
  const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
  const $ = (id) => document.getElementById(id);

  function toast(msg) {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1600);
  }

  // ---------- Season Settings ----------
  const targets = [0, 0, 220, 260, 280, 300, 320, 320, 340]; // index by episode
  const reasons = [
    "",
    "Start here.",
    "Pilot order.",
    "Forecast raised after pilot success.",
    "New customer trial order.",
    "Peak demand week.",
    "Orders locked (penalties if short).",
    "Repeat order (customer scrutiny).",
    "Final rush shipment."
  ];

  // ---------- Game State ----------
  let state;

  function resetState() {
    state = {
      ep: 1,
      totalCOP: 0,

      // cost rates
      dmUnit: 30,
      dlUnit: 18,
      deUnit: 4,
      vohUnit: 10,
      fixedFOH: 9000,

      // capacity
      baseCap: 380,

      // risk + scrap (burst thresholds)
      scrapRate: 0.00,  // burst if >= 3%
      qualityRisk: 0,   // burst if >= 3
      complaintFlag: false, // informational

      // flags
      choseCheapSupplier: false,
      vohAdjActive: false, // training effect Ep5–Ep8
      dmAdjActive: false,  // workshop effect Ep6–Ep8
      dlAdjActive: false,  // line balancing effect Ep7–Ep8

      // last SOC record should persist across episodes
      lastRecord: null
    };
  }

  // ---------- Episodes ----------
  const episodes = [
    null,
    {
      title: "Episode 1 — Set up your factory",
      story:
        "You choose your facility. Finance wants low fixed costs, but Operations warns fragile setups cause problems later. " +
        "This locks your fixed factory overhead and season capacity.",
      options: [
        { key: "A", text: "Deposit 5,000; Fixed FOH 9,000/episode; Capacity 380." },
        { key: "B", text: "Deposit 2,000; Fixed FOH 6,000/episode; Capacity 330." },
        { key: "C", text: "Deposit 10,000; Fixed FOH 12,000/episode; Capacity 450." }
      ]
    },
    {
      title: "Episode 2 — Materials sourcing (pilot order)",
      story:
        "A pilot run tests supplier quality. Cheaper materials can look good in COP but increase scrap and complaints later. " +
        "Choose how you source Direct Materials.",
      options: [
        { key: "A", text: "Standard supplier: DM 30/unit; extra cost 0." },
        { key: "B", text: "Bulk discount: handling/storage 8,000; DM becomes 28/unit from now on." },
        { key: "C", text: "Cheapest supplier: DM becomes 26/unit from now on (riskier)." }
      ]
    },
    {
      title: "Episode 3 — Ramp-up decision (forecast increases)",
      story:
        "The forecast rises after pilot success. You can invest in training, push overtime, or do nothing and accept rising waste later. " +
        "This is about incremental cost vs future rework/scrap.",
      options: [
        { key: "A", text: "Training: pay 3,000 now (reduce rework later)." },
        { key: "B", text: "Overtime: DL +5/unit this episode only." },
        { key: "C", text: "Do nothing: pay 0 now (hidden wastage later)." }
      ]
    },
    {
      title: "Episode 4 — Quality control vs “cost cutting”",
      story:
        "A trial order includes strict inspection. Cutting inspection can reduce FOH now, but raises quality and scrap risk. " +
        "Choose how you handle QC.",
      options: [
        { key: "A", text: "Keep inspection: FOH +1,500 this episode." },
        { key: "B", text: "Reduce inspection: FOH -1,000 this episode (riskier)." },
        { key: "C", text: "Process workshop: pay 2,500 now (improve materials later)." }
      ]
    },
    {
      title: "Episode 5 — Maintenance and the sunk cost trap",
      story:
        "Someone mentions last quarter’s 7,000 equipment study (sunk cost). Ignore it. Today’s relevant decision is maintenance vs running hot. " +
        "This affects waste later.",
      options: [
        { key: "A", text: "Preventive maintenance: pay 2,000 now." },
        { key: "B", text: "Skip maintenance: pay 0 now (risk later)." },
        { key: "C", text: "Replace worn part only: pay 1,200 now." }
      ]
    },
    {
      title: "Episode 6 — Locked orders (output must hit)",
      story:
        "Orders are locked. Scrap can now cause missed targets. Cutting spec may reduce cost now but trigger complaints. " +
        "You must deliver the target output.",
      options: [
        { key: "A", text: "Standard spec: no changes." },
        { key: "B", text: "Cost-cut spec: DM -3/unit this episode only (riskier)." },
        { key: "C", text: "Line balancing: pay 1,800 now; DL -2/unit in Ep7–Ep8." }
      ]
    },
    {
      title: "Episode 7 — Response to early complaints / instability",
      story:
        "Customer feedback is coming in. You can pay for containment, ignore it, or audit suppliers. " +
        "This is about relevant incremental cost to avoid bigger failures.",
      options: [
        { key: "A", text: "Containment & sorting: pay 2,400 now." },
        { key: "B", text: "Continue as-is: pay 0 now." },
        { key: "C", text: "Supplier audit: pay 3,500 now (most useful if supplier quality is the root cause)." }
      ]
    },
    {
      title: "Episode 8 — Finale (reputation test)",
      story:
        "Final shipment window. Management judges your COP and whether you met output without complaints exploding. " +
        "Low COP is meaningless if the customer churns.",
      options: [
        { key: "A", text: "Final quality push: FOH +3,000 this episode." },
        { key: "B", text: "“Numbers look good” push: FOH -1,500 this episode (riskier)." },
        { key: "C", text: "Rework sprint: DL +4/unit this episode (stabilize quality)." }
      ]
    }
  ];

  // ---------- Derived Adjustments ----------
  function currentDmUnit(ep, optKey=null) {
    let dm = state.dmUnit;
    if (state.dmAdjActive && ep >= 6) dm -= 2;       // workshop
    if (ep === 6 && optKey === "B") dm -= 3;         // spec cut
    return Math.max(0, dm);
  }
  function currentDlUnit(ep, optKey=null) {
    let dl = state.dlUnit;
    if (ep === 3 && optKey === "B") dl += 5;         // overtime
    if (state.dlAdjActive && ep >= 7) dl -= 2;       // line balancing
    if (ep === 8 && optKey === "C") dl += 4;         // rework sprint
    return Math.max(0, dl);
  }
  function currentVohUnit(ep) {
    let voh = state.vohUnit;
    if (state.vohAdjActive && ep >= 5) voh -= 2;     // training
    return Math.max(0, voh);
  }
  function effectiveCapacity() { return state.baseCap; } // stable capacity; scrap makes PU rise
  function neededProduction(target, scrapRate) {
    const sr = clamp(scrapRate, 0, 0.30);
    const pu = (target <= 0) ? 0 : ceil(target / (1 - sr));
    const extra = Math.max(0, pu - target);
    return { pu, extra, sr };
  }

  // ---------- SOC Calculation ----------
  function computeSOC(ep, optKey) {
    const target = targets[ep];
    const cap = effectiveCapacity();
    const { pu, extra, sr } = neededProduction(target, state.scrapRate);

    let fohOneOff = 0;
    if (ep === 2 && optKey === "B") fohOneOff += 8000;
    if (ep === 3 && optKey === "A") fohOneOff += 3000;
    if (ep === 4 && optKey === "A") fohOneOff += 1500;
    if (ep === 4 && optKey === "B") fohOneOff -= 1000;
    if (ep === 4 && optKey === "C") fohOneOff += 2500;
    if (ep === 5 && optKey === "A") fohOneOff += 2000;
    if (ep === 5 && optKey === "C") fohOneOff += 1200;
    if (ep === 6 && optKey === "C") fohOneOff += 1800;
    if (ep === 7 && optKey === "A") fohOneOff += 2400;
    if (ep === 7 && optKey === "C") fohOneOff += 3500;
    if (ep === 8 && optKey === "A") fohOneOff += 3000;
    if (ep === 8 && optKey === "B") fohOneOff -= 1500;

    const dmU = currentDmUnit(ep, optKey);
    const dlU = currentDlUnit(ep, optKey);
    const deU = state.deUnit;
    const vohU = currentVohUnit(ep);

    const DM = pu * dmU;
    const DL = pu * dlU;
    const DE = pu * deU;
    const prime = DM + DL + DE;

    const FOH = (ep >= 2 ? state.fixedFOH : 0) + (pu * vohU) + fohOneOff;
    const COP = prime + FOH;

    const achievedTarget = (pu <= cap);

    return {
      ep, target, cap,
      scrapRate: sr,
      pu, extra, achievedTarget,
      dmU, dlU, deU, vohU,
      fixedFOH: (ep >= 2 ? state.fixedFOH : 0),
      fohOneOff,
      DM, DL, DE, prime, FOH, COP
    };
  }

  // ---------- Apply Choice Effects ----------
  function applyChoiceEffects(ep, optKey, notes) {
    if (ep === 1) {
      if (optKey === "A") {
        state.fixedFOH = 9000; state.baseCap = 380;
        notes.push("Setup chosen: Fixed FOH set to 9,000/episode. Capacity set to 380.");
      } else if (optKey === "B") {
        state.fixedFOH = 6000; state.baseCap = 330;
        notes.push("Setup chosen: Fixed FOH set to 6,000/episode. Capacity set to 330 (tighter).");
      } else {
        state.fixedFOH = 12000; state.baseCap = 450;
        notes.push("Setup chosen: Fixed FOH set to 12,000/episode. Capacity set to 450 (strong).");
      }
      return;
    }

    if (ep === 2) {
      if (optKey === "A") {
        state.dmUnit = 30;
        notes.push("DM stays 30/unit (stable quality baseline).");
      } else if (optKey === "B") {
        state.dmUnit = 28;
        notes.push("Bulk discount: DM becomes 28/unit from now on. Handling/storage is counted in this episode’s overheads.");
      } else {
        state.dmUnit = 26;
        state.scrapRate += 0.01;
        state.qualityRisk += 1;
        state.complaintFlag = true;
        state.choseCheapSupplier = true;
        notes.push("Cheapest supplier: DM becomes 26/unit. Scrap +1% and Quality risk +1 (higher complaint chance).");
      }
      return;
    }

    if (ep === 3) {
      if (optKey === "A") {
        state.vohAdjActive = true;
        notes.push("Training: adds cost now, but reduces future rework overheads (Ep5–Ep8).");
      } else if (optKey === "B") {
        notes.push("Overtime: higher labour cost this episode only.");
      } else {
        state.scrapRate += 0.03;
        notes.push("Do nothing: scrap jumps up (waste increases).");
      }
      return;
    }

    if (ep === 4) {
      if (optKey === "A") {
        notes.push("Keep inspection: prevention cost this episode; helps avoid complaints.");
      } else if (optKey === "B") {
        state.qualityRisk += 1;
        state.scrapRate += 0.01;
        state.complaintFlag = true;
        notes.push("Reduce inspection: cost looks lower now, but complaints and waste risk increase.");
      } else {
        state.dmAdjActive = true;
        notes.push("Process workshop: cost now, but improves material usage later (Ep6–Ep8).");
      }
      return;
    }

    if (ep === 5) {
      notes.push("Reminder: last quarter’s 7,000 equipment study is a SUNK cost (irrelevant today).");
      if (optKey === "A") {
        state.scrapRate -= 0.02;
        notes.push("Preventive maintenance: reduces waste (scrap improves).");
      } else if (optKey === "B") {
        state.qualityRisk += 1;
        state.complaintFlag = true;
        notes.push("Skip maintenance: saves money now, but complaints risk increases.");
      } else {
        notes.push("Replace part: improves reliability, but doesn’t reduce waste much.");
      }
      state.scrapRate = clamp(state.scrapRate, 0, 0.30);
      return;
    }

    if (ep === 6) {
      if (optKey === "A") {
        notes.push("Standard spec: stable path.");
      } else if (optKey === "B") {
        state.qualityRisk += 1;
        state.complaintFlag = true;
        state.scrapRate += 0.02;
        notes.push("Cost-cut spec: lower material cost now, but complaints and waste increase.");
      } else {
        state.dlAdjActive = true;
        notes.push("Line balancing: cost now, but labour becomes more efficient later (Ep7–Ep8).");
      }
      state.scrapRate = clamp(state.scrapRate, 0, 0.30);
      return;
    }

    if (ep === 7) {
      if
